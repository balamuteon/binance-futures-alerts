<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Binance Futures Alerts</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: rgba(15, 23, 42, 0.72);
            --bg-glass: rgba(30, 41, 59, 0.75);
            --accent: #38bdf8;
            --accent-strong: #0ea5e9;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --success: #34d399;
            --danger: #f87171;
            --neutral: #94a3b8;
            --card-shadow: 0 24px 60px rgba(15, 23, 42, 0.55);
            --blur: blur(22px);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: radial-gradient(circle at top, #1e293b 0%, #0f172a 50%, #020617 100%);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before,
        body::after {
            content: "";
            position: fixed;
            width: 420px;
            height: 420px;
            border-radius: 50%;
            filter: blur(150px);
            opacity: 0.42;
            z-index: 0;
        }

        body::before {
            background: #38bdf8;
            top: -160px;
            right: -80px;
        }

        body::after {
            background: #f97316;
            bottom: -200px;
            left: -140px;
        }

        .app-shell {
            width: min(960px, 94%);
            margin: 0 auto;
            backdrop-filter: var(--blur);
            background: linear-gradient(145deg, var(--bg-secondary), rgba(15, 23, 42, 0.55));
            border-radius: 28px;
            padding: 36px 40px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            gap: 28px;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(148, 163, 184, 0.08);
            transition: width 0.38s ease;
        }

        .header {
            display: flex;
            justify-content: space-between;
            gap: 24px;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        h1 {
            margin: 0;
            font-size: clamp(28px, 4vw, 36px);
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .subtitle {
            margin-top: 8px;
            color: var(--text-secondary);
            font-size: 16px;
            max-width: 520px;
            line-height: 1.6;
        }

        .status {
            padding: 10px 16px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            align-self: flex-start;
            transition: background 0.3s ease, color 0.3s ease;
            border: 1px solid transparent;
        }

        .status::before {
            content: "";
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: currentColor;
            box-shadow: 0 0 12px currentColor;
        }

        .status-connecting {
            color: #facc15;
            background: rgba(250, 204, 21, 0.1);
            border-color: rgba(250, 204, 21, 0.25);
        }

        .status-connected {
            color: var(--success);
            background: rgba(52, 211, 153, 0.1);
            border-color: rgba(52, 211, 153, 0.25);
        }

        .status-disconnected {
            color: var(--danger);
            background: rgba(248, 113, 113, 0.12);
            border-color: rgba(248, 113, 113, 0.32);
        }

        .content {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            gap: 28px;
        }

        #alertsList {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: min(540px, 60vh);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(148, 163, 184, 0.4) transparent;
        }

        #alertsList::-webkit-scrollbar {
            width: 8px;
        }

        #alertsList::-webkit-scrollbar-track {
            background: transparent;
        }

        #alertsList::-webkit-scrollbar-thumb {
            background-color: rgba(148, 163, 184, 0.4);
            border-radius: 999px;
        }

        .alert {
            background: rgba(15, 23, 42, 0.76);
            border: 1px solid rgba(148, 163, 184, 0.12);
            border-left: 6px solid var(--accent);
            border-radius: 18px;
            padding: 18px 22px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 12px 30px rgba(8, 47, 73, 0.24);
            position: relative;
            overflow: hidden;
            flex: 0 0 auto;
        }

        .alert::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.09), rgba(236, 72, 153, 0.04));
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .alert:hover::after {
            opacity: 1;
        }

        .alert > div {
            position: relative;
            z-index: 1;
        }

        .alert-symbol {
            font-weight: 700;
            color: var(--accent);
            text-decoration: none;
            letter-spacing: 0.02em;
        }

        .alert-symbol:hover {
            color: var(--accent-strong);
        }

        .alert-details {
            font-size: 0.95rem;
            color: var(--text-secondary);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .alert-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-left: auto;
            font-weight: 600;
        }

        .alert-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
        }

        .alert-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .alert-title::before {
            content: "";
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            box-shadow: 0 0 8px currentColor;
        }

        .price-rise {
            border-left-color: var(--success);
        }

        .price-fall {
            border-left-color: var(--danger);
        }

        .price-neutral {
            border-left-color: var(--neutral);
        }

        .actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        button,
        #enableSoundButton {
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.2), rgba(14, 165, 233, 0.6));
            color: var(--text-primary);
            border: 1px solid rgba(56, 189, 248, 0.4);
            border-radius: 14px;
            padding: 12px 20px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        button:hover,
        #enableSoundButton:hover {
            transform: translateY(-1px);
            box-shadow: 0 16px 30px rgba(8, 47, 73, 0.35);
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.35), rgba(14, 165, 233, 0.8));
        }

        button:active,
        #enableSoundButton:active {
            transform: translateY(0);
        }

        .floating-info {
            position: fixed;
            right: 24px;
            bottom: 24px;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }

        .info-trigger {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            border: 1px solid rgba(56, 189, 248, 0.35);
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.6), rgba(15, 23, 42, 0.6));
            color: var(--text-primary);
            display: grid;
            place-items: center;
            font-size: 22px;
            font-weight: 700;
            cursor: help;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            backdrop-filter: blur(18px);
        }

        .info-trigger:hover,
        .floating-info:focus-within .info-trigger {
            transform: translateY(-4px);
            box-shadow: 0 18px 36px rgba(8, 47, 73, 0.5);
        }

        .info-tooltip {
            pointer-events: none;
            opacity: 0;
            transform: translateY(6px);
            transition: opacity 0.25s ease, transform 0.25s ease;
            background: rgba(15, 23, 42, 0.92);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 18px;
            padding: 18px 22px;
            width: min(320px, 80vw);
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
            box-shadow: 0 22px 40px rgba(8, 47, 73, 0.45);
        }

        .info-tooltip strong {
            color: var(--text-primary);
        }

        .floating-info:hover .info-tooltip,
        .floating-info:focus-within .info-tooltip {
            pointer-events: auto;
            opacity: 1;
            transform: translateY(-4px);
        }

        .alerts-area {
            display: flex;
            flex-direction: column;
            gap: 28px;
            flex: 1 1 auto;
            min-width: 0;
            transform: translateX(0);
            transition: flex-basis 0.35s ease, max-width 0.35s ease, transform 0.35s ease;
        }

        .chart-panel {
            position: relative;
            display: flex;
            flex-direction: column;
            flex: 0 0 0;
            min-width: 0;
            max-width: 0;
            opacity: 0;
            transform: translateX(48px);
            overflow: hidden;
            pointer-events: none;
            transition: flex-basis 0.38s ease, opacity 0.32s ease, transform 0.38s ease;
        }

        .chart-panel__container {
            height: 100%;
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.18);
            background: linear-gradient(160deg, rgba(15, 23, 42, 0.92), rgba(15, 23, 42, 0.6));
            box-shadow: 0 30px 80px rgba(8, 47, 73, 0.55);
            padding: 22px 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: clamp(450px, 62vh, 680px);
        }

        .chart-panel__header {
            display: flex;
            align-items: center;
            gap: 18px;
            flex-wrap: wrap;
        }

        .chart-panel__meta {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .chart-panel__symbol {
            font-size: clamp(22px, 3vw, 30px);
            font-weight: 700;
            letter-spacing: 0.08em;
            color: var(--accent);
            text-transform: uppercase;
        }

        .chart-panel__subtitle {
            color: var(--text-secondary);
            font-size: 13px;
            letter-spacing: 0.06em;
            text-transform: uppercase;
        }

        .chart-panel__controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: auto;
        }

        .chart-panel__open {
            padding: 8px 16px;
            border-radius: 999px;
            background: rgba(56, 189, 248, 0.18);
            border: 1px solid rgba(56, 189, 248, 0.42);
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            transition: background 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }

        .chart-panel__open:hover {
            background: rgba(56, 189, 248, 0.32);
            border-color: rgba(56, 189, 248, 0.62);
            transform: translateY(-1px);
        }

        .chart-panel__close {
            width: 38px;
            height: 38px;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.26);
            background: rgba(15, 23, 42, 0.72);
            color: var(--text-secondary);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }

        .chart-panel__close:hover {
            color: var(--text-primary);
            border-color: rgba(56, 189, 248, 0.5);
            transform: translateY(-1px);
        }

        .chart-panel__frame {
            flex: 1 1 auto;
            min-height: clamp(380px, 55vh, 600px);
            border-radius: 20px;
            overflow: hidden;
            background: rgba(15, 23, 42, 0.82);
        }

        .chart-panel__frame iframe {
            width: 100%;
            height: 100%;
            border: 0;
        }

        .app-shell--chart-open {
            width: min(1380px, 96%);
        }

        .app-shell--chart-open .content {
            gap: 24px;
        }

        .app-shell--chart-open .alerts-area {
            flex: 0 0 34%;
            max-width: 34%;
            transform: translateX(-12px);
        }

        .app-shell--chart-open .chart-panel {
            flex: 1 1 auto;
            max-width: 100%;
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        .alert-symbol--active {
            color: var(--text-primary);
            text-shadow: 0 0 16px rgba(56, 189, 248, 0.55);
        }

        @media (max-width: 720px) {
            body {
                padding: 24px 16px 100px;
            }

            .app-shell {
                padding: 28px 24px;
                border-radius: 24px;
            }

            .content {
                flex-direction: column;
                gap: 20px;
            }

            .alerts-area {
                gap: 20px;
            }

            .app-shell--chart-open {
                width: min(960px, 100%);
            }

            .app-shell--chart-open .content {
                flex-direction: column;
            }

            .app-shell--chart-open .alerts-area,
            .app-shell--chart-open .chart-panel {
                flex: 1 1 auto;
                max-width: 100%;
            }

            .chart-panel__controls {
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
            }

            .chart-panel__close {
                order: 2;
            }

            .chart-panel__container {
                min-height: clamp(360px, 66vh, 560px);
            }

            .chart-panel__frame {
                min-height: clamp(320px, 60vh, 520px);
            }

            .alert {
                border-radius: 16px;
                padding: 16px 18px;
            }

            .subtitle {
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <header class="header">
            <div>
                <h1>Binance Futures Alerts</h1>
                <p class="subtitle">удобный онлайн-инструмент для трейдеров, который мгновенно уведомляет о резких изменениях на рынке.</p>
            </div>
            <div id="status" class="status status-connecting">Связываемся с потоком сигналов...</div>
        </header>

        <main class="content">
            <section class="alerts-area">
                <ul id="alertsList"></ul>

                <div class="actions">
                    <button type="button" onclick="playSoundTest()">Послушать тестовый сигнал</button>
                    <audio id="testAudioPlayer" src="alert.wav" preload="auto"></audio>
                </div>
            </section>

            <aside id="chartPanel" class="chart-panel" aria-hidden="true">
                <div class="chart-panel__container">
                    <div class="chart-panel__header">
                        <div class="chart-panel__meta">
                            <span id="chartPanelSymbol" class="chart-panel__symbol">—</span>
                            <span class="chart-panel__subtitle">TradingView • 15m</span>
                        </div>
                        <div class="chart-panel__controls">
                            <a id="chartPanelOpen" class="chart-panel__open" href="#" target="_blank" rel="noopener" tabindex="-1">Открыть в TradingView</a>
                            <button type="button" id="chartPanelClose" class="chart-panel__close" aria-label="Закрыть график" tabindex="-1">×</button>
                        </div>
                    </div>
                    <div class="chart-panel__frame"></div>
                </div>
            </aside>
        </main>
    </div>

    <div class="floating-info">
        <button type="button" class="info-trigger" aria-label="Что это за сайт?" tabindex="0">i</button>
        <div class="info-tooltip">
            <strong>Info.</strong><br>
            Следите за фьючерсами Binance в реальном времени: если цена любого контракта изменится более чем на 2% за последнюю минуту, вы сразу получите уведомление и звуковой сигнал. Просто откройте сайт и оставайтесь в курсе быстрых движений рынка - никаких задержек, только live-сигналы.
        </div>
    </div>

    <script>
        // Функция для тестовой кнопки
        function playSoundTest() {
            console.log("НАЖАТА КНОПКА 'Послушать тестовый сигнал'");
            const testPlayer = document.getElementById('testAudioPlayer');
            if (testPlayer) {
                testPlayer.play()
                    .then(() => {
                        console.log("Тестовый звук (с кнопки) УСПЕШНО воспроизведен!");
                        alert("Если все хорошо, вы услышали короткий сигнал.");
                    })
                    .catch(error => {
                        console.error("Ошибка тестового воспроизведения звука (с кнопки):", error);
                        alert("Не удалось воспроизвести звук: " + error.name + " - " + error.message);
                    });
            } else {
                console.error("Тестовый плеер #testAudioPlayer не найден!");
            }
        }
    </script>

    <script>
        // Основной скрипт приложения
        document.addEventListener("DOMContentLoaded", function() {
            console.log("ОСНОВНОЙ СКРИПТ: DOMContentLoaded сработал.");

            const alertsList = document.getElementById("alertsList");
            const statusDiv = document.getElementById("status");
            const appShell = document.querySelector(".app-shell");
            const chartPanel = document.getElementById("chartPanel");
            const chartPanelFrame = chartPanel ? chartPanel.querySelector(".chart-panel__frame") : null;
            const chartPanelSymbol = document.getElementById("chartPanelSymbol");
            const chartPanelOpenLink = document.getElementById("chartPanelOpen");
            const chartPanelCloseButton = document.getElementById("chartPanelClose");
            let chartActiveLink = null;
            let chartActiveSymbol = null;
            let socket;

            const alertSound = new Audio('alert.wav');
            alertSound.preload = 'auto';

            function ensureChartIframe(symbol) {
                if (!chartPanelFrame) { return; }

                let iframe = chartPanelFrame.querySelector("iframe");
                const embedUrl = `https://www.tradingview.com/widgetembed/?symbol=${encodeURIComponent(symbol)}&interval=15&symboledit=1&saveimage=0&toolbarbg=f1f3f6&studies=[]&hideideas=1&theme=dark&style=1&timezone=Etc/UTC&hidevolume=1&withdateranges=0&allow_symbol_change=1&locale=ru`;

                if (!iframe) {
                    iframe = document.createElement("iframe");
                    iframe.setAttribute("allowtransparency", "true");
                    iframe.setAttribute("scrolling", "no");
                    iframe.loading = "lazy";
                    iframe.title = "TradingView preview";
                    iframe.referrerPolicy = "no-referrer-when-downgrade";
                    chartPanelFrame.appendChild(iframe);
                }

                if (iframe.dataset.loadedSymbol !== symbol) {
                    iframe.src = embedUrl;
                    iframe.dataset.loadedSymbol = symbol;
                }
            }

            function setActiveSymbolLink(link) {
                if (!alertsList) { return; }
                const activeLinks = alertsList.querySelectorAll(".alert-symbol--active");
                activeLinks.forEach(activeLink => {
                    if (activeLink !== link) {
                        activeLink.classList.remove("alert-symbol--active");
                    }
                });

                if (link) {
                    link.classList.add("alert-symbol--active");
                }
            }

            function openChartPanel(link) {
                if (!chartPanel || !chartPanelOpenLink || !appShell) { return; }
                if (!link || !link.dataset.tvSymbol) { return; }

                const symbol = link.dataset.tvSymbol;
                ensureChartIframe(symbol);

                if (chartPanelSymbol) {
                    const baseSymbol = link.dataset.rawSymbol || (link.textContent ? link.textContent.trim() : symbol);
                    chartPanelSymbol.textContent = baseSymbol || symbol;
                    chartPanelSymbol.title = symbol;
                }

                chartPanel.dataset.symbol = symbol;
                chartPanelOpenLink.href = link.href;
                chartPanelOpenLink.removeAttribute("tabindex");
                if (chartPanelCloseButton) {
                    chartPanelCloseButton.removeAttribute("tabindex");
                }

                chartActiveSymbol = symbol;
                chartActiveLink = link;
                setActiveSymbolLink(link);

                appShell.classList.add("app-shell--chart-open");
                chartPanel.setAttribute("aria-hidden", "false");
            }

            function closeChartPanel() {
                if (!chartPanel || !appShell) { return; }
                chartPanel.removeAttribute("data-symbol");
                chartPanel.setAttribute("aria-hidden", "true");
                appShell.classList.remove("app-shell--chart-open");
                if (chartPanelSymbol) {
                    chartPanelSymbol.textContent = "—";
                    chartPanelSymbol.removeAttribute("title");
                }
                if (chartPanelOpenLink) {
                    chartPanelOpenLink.href = "#";
                    chartPanelOpenLink.setAttribute("tabindex", "-1");
                }
                if (chartPanelCloseButton) {
                    chartPanelCloseButton.setAttribute("tabindex", "-1");
                }
                chartActiveSymbol = null;
                chartActiveLink = null;
                setActiveSymbolLink(null);
            }

            function isModifiedEvent(event) {
                return event.button !== 0 || event.metaKey || event.ctrlKey || event.shiftKey || event.altKey;
            }

            function handleSymbolClick(event) {
                const link = event.currentTarget;
                if (isModifiedEvent(event)) { return; }
                event.preventDefault();

                if (chartActiveSymbol === link.dataset.tvSymbol) {
                    openChartPanel(link);
                    return;
                }

                openChartPanel(link);
            }

            function handleDocumentKeydown(event) {
                if (event.key === "Escape" && chartPanel && chartPanel.getAttribute("aria-hidden") === "false") {
                    closeChartPanel();
                }
            }

            function syncChartPanelLink() {
                if (!alertsList || !chartActiveSymbol) {
                    chartActiveLink = null;
                    setActiveSymbolLink(null);
                    return;
                }

                const links = alertsList.querySelectorAll(".alert-symbol");
                let matchedLink = null;

                links.forEach(candidate => {
                    if (!matchedLink && candidate.dataset.tvSymbol === chartActiveSymbol) {
                        matchedLink = candidate;
                    }
                });

                chartActiveLink = matchedLink;
                setActiveSymbolLink(matchedLink);
            }

            if (chartPanelCloseButton) {
                chartPanelCloseButton.addEventListener("click", () => {
                    closeChartPanel();
                });
            }

            document.addEventListener("keydown", handleDocumentKeydown);

            function updateStatus(state, text) {
                statusDiv.textContent = text;
                statusDiv.className = `status ${state}`;
            }

            function connect() {
                updateStatus("status-connecting", "Связываемся с потоком сигналов...");
                const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
                const wsUrl = `${wsProtocol}//${window.location.host}/ws/alerts`;

                socket = new WebSocket(wsUrl);

                socket.onopen = function() {
                    updateStatus("status-connected", "На связи: получаем новые сигналы.");
                };

                socket.onmessage = function(event) {
                    try {
                        const alertData = JSON.parse(event.data);
                        displayAlert(alertData);

                        alertSound.play()
                            .catch(error => {
                                console.error("!!!!! ОСНОВНОЙ СКРИПТ: alertSound.play() НЕ УДАЛОСЬ:", error.name, error.message);

                                if (!document.getElementById('enableSoundButton')) {
                                    const enableSoundButton = document.createElement('button');
                                    enableSoundButton.id = 'enableSoundButton';
                                    enableSoundButton.textContent = 'Разрешить звук сигналов';
                                    enableSoundButton.onclick = () => {
                                        alertSound.play().then(() => {
                                            enableSoundButton.style.display = 'none';
                                        }).catch(e => console.error("ОСНОВНОЙ СКРИПТ: Ошибка при активации звука пользователем через кнопку:", e));
                                    };

                                    if (statusDiv && statusDiv.parentNode) {
                                        statusDiv.parentNode.insertBefore(enableSoundButton, statusDiv.nextSibling);
                                    } else {
                                        document.body.appendChild(enableSoundButton); // Запасной вариант
                                    }
                                }
                            });
                    } catch (e) {
                        console.error("ОСНОВНОЙ СКРИПТ: Ошибка парсинга JSON или в displayAlert:", e);
                    }
                };

                socket.onerror = function(error) {
                    console.error("ОСНОВНОЙ СКРИПТ: WebSocket onerror:", error);
                    updateStatus("status-disconnected", "Что-то помешало подключению. Пробуем снова...");
                };

                socket.onclose = function(event) {
                    console.log("ОСНОВНОЙ СКРИПТ: WebSocket onclose. Код:", event.code, "Причина:", event.reason, "Было чисто:", event.wasClean);
                    updateStatus("status-disconnected", "Потеряли связь. Переподключимся через 5 секунд...");
                    setTimeout(connect, 5000);
                };
            }

            function displayAlert(data) {
                if (!alertsList) { return; }
                if (!data || !data.symbol) { return; }

                const listItem = document.createElement("li");
                listItem.classList.add("alert");

                const eventTime = new Date(data.timestamp).toLocaleString('ru-RU');

                const originalBinanceTicker = data.symbol;
                const tickerForTradingViewUrl = `${originalBinanceTicker}.P`;
                const tradingViewSymbolParam = `BINANCE:${tickerForTradingViewUrl}`;
                const tradingViewUrl = `https://www.tradingview.com/chart/?symbol=${encodeURIComponent(tradingViewSymbolParam)}`;

                let movementText = "";
                let movementClass = "";

                if (data.percentageChange > 0) {
                    movementText = `выросла на <strong>${data.percentageChange.toFixed(2)}%</strong>`;
                    movementClass = "price-rise";
                } else if (data.percentageChange < 0) {
                    movementText = `упала на <strong>${Math.abs(data.percentageChange).toFixed(2)}%</strong>`;
                    movementClass = "price-fall";
                } else {
                    movementText = "осталась без изменений";
                    movementClass = "price-neutral";
                }

                listItem.classList.add(movementClass);

                listItem.innerHTML = `
                    <div class="alert-header">
                        <span class="alert-title">Свежий сигнал</span>
                        <a href="${tradingViewUrl}" target="_blank" class="alert-symbol" title="Открыть ${tickerForTradingViewUrl} на TradingView">${originalBinanceTicker}</a>
                        <span class="alert-time">${eventTime}</span>
                    </div>
                    <div>
                        Цена ${movementText} за последние 60 секунд.
                    </div>
                    <div class="alert-details">
                        <span>Сейчас: <strong>${data.currentPrice.toFixed(4)}</strong></span>
                        <span>Минуту назад: <strong>${data.oldestPrice.toFixed(4)}</strong></span>
                    </div>
                `;

                const symbolLink = listItem.querySelector(".alert-symbol");
                if (symbolLink) {
                    symbolLink.dataset.tvSymbol = tradingViewSymbolParam;
                    symbolLink.dataset.rawSymbol = originalBinanceTicker;
                    symbolLink.addEventListener("click", handleSymbolClick);
                }

                alertsList.prepend(listItem);

                while (alertsList.children.length > 50) {
                    const lastChild = alertsList.lastChild;
                    alertsList.removeChild(lastChild);
                }

                if (chartActiveSymbol) {
                    syncChartPanelLink();
                }
            }

            connect();
        });
    </script>
</body>
</html>
